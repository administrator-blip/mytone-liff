<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MYTONE äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- LIFF SDK: å‹•çš„èª­ã¿è¾¼ã¿ï¼ˆCDNãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œï¼‰ -->
    <style>
        /* ========== ãƒªã‚»ãƒƒãƒˆãƒ»ãƒ™ãƒ¼ã‚¹ ========== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            height: 100%;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: #f0f4f0;
            color: #1a1a1a;
            min-height: 100%;
            padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
        }

        /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
        .app-header {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: #fff;
            padding: 14px 16px;
            padding-top: calc(env(safe-area-inset-top) + 14px);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-header h1 {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .app-header .role-badge {
            display: inline-block;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            padding: 2px 8px;
            margin-top: 3px;
        }

        /* ========== å…±é€š ========== */
        .hidden {
            display: none !important;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 12px 14px;
        }

        /* ========== ã‚«ãƒ¼ãƒ‰ ========== */
        .card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
        }

        /* ========== ãƒœã‚¿ãƒ³ ========== */
        .btn {
            display: block;
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            margin-top: 8px;
            transition: opacity 0.15s, transform 0.1s;
            letter-spacing: 0.03em;
        }

        .btn:active {
            opacity: 0.75;
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.45;
            cursor: default;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: #fff;
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.35);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #546e7a, #78909c);
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c62828, #e53935);
            color: #fff;
        }

        .btn-outline {
            background: #fff;
            color: #2e7d32;
            border: 2px solid #2e7d32;
        }

        .btn-small {
            display: inline-block;
            width: auto;
            padding: 8px 14px;
            font-size: 0.85rem;
            margin-top: 6px;
        }

        /* ========== ãƒ•ã‚©ãƒ¼ãƒ  ========== */
        label {
            display: block;
            font-size: 0.82rem;
            font-weight: 700;
            color: #555;
            margin-top: 12px;
            margin-bottom: 4px;
        }

        input,
        select {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            background: #fafafa;
            color: #1a1a1a;
            appearance: none;
            -webkit-appearance: none;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #2e7d32;
            background: #fff;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        /* ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========== */
        .msg-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #e53935;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.88rem;
            margin-top: 8px;
        }

        .msg-success {
            background: #e8f5e9;
            color: #1b5e20;
            border-left: 4px solid #43a047;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.88rem;
            margin-top: 8px;
        }

        .msg-info {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.88rem;
            margin-top: 8px;
            color: #0d47a1;
        }

        .msg-warn {
            background: #fff8e1;
            border-left: 4px solid #f9a825;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.88rem;
            margin-top: 8px;
            color: #e65100;
        }

        /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #e8f5e9;
            border-top-color: #2e7d32;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #888;
            font-size: 0.9rem;
        }

        /* ========== ã‚¿ãƒ–ãƒãƒ¼ ========== */
        .tab-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            background: #e8f5e9;
            border-radius: 12px;
            padding: 4px;
        }

        .tab-bar .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 9px;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
        }

        .tab-bar .tab.active {
            background: #fff;
            color: #2e7d32;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
        }

        /* ========== ã‚¹ãƒ­ãƒƒãƒˆãƒœã‚¿ãƒ³ ========== */
        .slot-btn {
            display: block;
            width: 100%;
            padding: 12px 14px;
            margin: 6px 0;
            border: 1.5px solid #a5d6a7;
            border-radius: 10px;
            background: #f1f8e9;
            color: #1b5e20;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
        }

        .slot-btn:active {
            background: #c8e6c9;
        }

        .slot-btn.selected {
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: #fff;
            border-color: #2e7d32;
        }

        /* ========== è¨ºæ–­å£«ã‚°ãƒ«ãƒ¼ãƒ— ========== */
        .diag-group {
            margin-bottom: 14px;
        }

        .diag-group-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1b5e20;
            background: #e8f5e9;
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        /* ========== äºˆç´„ã‚¢ã‚¤ãƒ†ãƒ  ========== */
        .booking-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 0;
        }

        .booking-item:last-child {
            border-bottom: none;
        }

        .booking-item .bi-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .booking-item .bi-step {
            display: inline-block;
            font-size: 0.72rem;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 6px;
            padding: 2px 7px;
            margin-left: 6px;
            font-weight: 700;
        }

        .booking-item .bi-sub {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
        }

        .booking-item .bi-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .booking-item .bi-actions .btn {
            margin-top: 0;
        }

        /* ========== ç¨¼åƒæ ã‚¢ã‚¤ãƒ†ãƒ  ========== */
        .avail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .avail-item:last-child {
            border-bottom: none;
        }

        .avail-time {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        /* ========== ç¢ºèªè©³ç´° ========== */
        .confirm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92rem;
        }

        .confirm-table tr td {
            padding: 7px 4px;
            border-bottom: 1px solid #f0f0f0;
        }

        .confirm-table tr:last-child td {
            border-bottom: none;
        }

        .confirm-table td:first-child {
            font-weight: 700;
            color: #555;
            width: 5em;
        }

        /* ========== ç™»éŒ²ç”»é¢ ========== */
        .register-hero {
            text-align: center;
            padding: 20px 0 12px;
        }

        .register-hero .icon {
            font-size: 3rem;
            margin-bottom: 8px;
        }

        /* ========== æ—¥ä»˜ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
        .date-nav {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }

        .date-nav input[type="date"] {
            flex: 1;
            margin-top: 0;
        }

        .btn-nav {
            flex-shrink: 0;
            width: 40px;
            height: 46px;
            border: 1.5px solid #a5d6a7;
            border-radius: 10px;
            background: #f1f8e9;
            color: #2e7d32;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-nav:active {
            background: #c8e6c9;
        }

        /* ========== ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ ========== */
        .sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 200;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .sheet-overlay.show {
            display: block;
            opacity: 1;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 8px 16px calc(env(safe-area-inset-bottom) + 24px);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.18);
            z-index: 201;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 88vh;
            overflow-y: auto;
        }

        .bottom-sheet.show {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 14px;
        }

        .sheet-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
        }

        /* ========== äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‰ãƒƒãƒˆ ========== */
        .urgency-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }

        .dot-today {
            background: #e53935;
        }

        .dot-tomorrow {
            background: #fb8c00;
        }

        .dot-week {
            background: #43a047;
        }

        .dot-later {
            background: #b0bec5;
        }

        .bi-date-today {
            color: #c62828;
            font-weight: 700;
        }

        .bi-date-tomorrow {
            color: #e65100;
            font-weight: 600;
        }

        .bi-date-week {
            color: #2e7d32;
        }

        .bi-date-later {
            color: #666;
        }

        /* ========== ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ ========== */
        .btn-copy {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1.5px solid #a5d6a7;
            border-radius: 8px;
            background: #f1f8e9;
            color: #2e7d32;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 6px;
        }

        .btn-copy:active {
            background: #c8e6c9;
        }

        /* ========== ä»Šæ—¥ã‚µãƒãƒªãƒ¼ãƒãƒ¼ ========== */
        .today-summary {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #e8f5e9;
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .today-summary:active {
            background: #c8e6c9;
        }

        .today-summary .ts-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1b5e20;
        }

        .today-summary .ts-label {
            font-size: 0.85rem;
            color: #555;
            flex: 1;
        }

        /* ========== åº—èˆ—åãƒãƒƒã‚¸ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ ========== */
        .salon-badge {
            font-size: 0.72rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 1px;
        }

        /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ ========== */
        .dark-toggle {
            position: absolute;
            top: 50%;
            right: 14px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }

        .dark-toggle:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ========== ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
        @keyframes shimmer {
            0% {
                background-position: -400px 0;
            }

            100% {
                background-position: 400px 0;
            }
        }

        .skeleton-item {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 400px 100%;
            animation: shimmer 1.4s infinite linear;
            border-radius: 10px;
            height: 84px;
            margin-bottom: 10px;
        }

        .skeleton-line {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 400px 100%;
            animation: shimmer 1.4s infinite linear;
            border-radius: 6px;
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 55%;
        }

        .skeleton-line.medium {
            width: 75%;
        }

        /* ========== ãƒ—ãƒ«ãƒˆã‚¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ========== */
        #pullIndicator {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #666;
            transition: height 0.2s;
            overflow: hidden;
            height: 0;
        }

        #pullIndicator.visible {
            height: 40px;
        }

        /* ========== è¨ºæ–­å£«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ========== */
        .diag-filter-label {
            font-size: 0.8rem;
            color: #555;
            margin-top: 10px;
            margin-bottom: 2px;
        }

        /* ========== é¡§å®¢å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
        #historySheet .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.88rem;
        }

        #historySheet .history-item:last-child {
            border-bottom: none;
        }

        #historySheet .history-step {
            display: inline-block;
            font-size: 0.72rem;
            padding: 1px 7px;
            border-radius: 10px;
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: 700;
            margin-left: 5px;
        }

        /* ========== ç®¡ç†çµ±è¨ˆ ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            background: #f1f8e9;
            border-radius: 12px;
            padding: 12px 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.7rem;
            font-weight: 800;
            color: #1b5e20;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.72rem;
            color: #555;
            margin-top: 4px;
        }

        /* ========== é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ========== */
        .week-cal {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-top: 8px;
        }

        .week-day {
            flex-shrink: 0;
            width: 44px;
            border-radius: 10px;
            background: #f1f8e9;
            padding: 6px 4px;
            text-align: center;
            cursor: pointer;
            transition: background 0.15s;
        }

        .week-day:active {
            background: #c8e6c9;
        }

        .week-day .wd-date {
            font-size: 0.65rem;
            color: #666;
        }

        .week-day .wd-dow {
            font-size: 0.8rem;
            font-weight: 700;
            color: #1b5e20;
        }

        .week-day .wd-slots {
            font-size: 0.65rem;
            color: #388e3c;
            margin-top: 3px;
        }

        .week-day.wd-today {
            background: #c8e6c9;
            border: 2px solid #2e7d32;
        }

        .week-day.wd-selected {
            background: #2e7d32;
        }

        .week-day.wd-selected .wd-dow,
        .week-day.wd-selected .wd-date,
        .week-day.wd-selected .wd-slots {
            color: #fff;
        }

        /* ========== LINEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ========== */
        .line-preview {
            background: #06c755;
            border-radius: 12px;
            padding: 10px 12px;
            margin-top: 10px;
            color: #fff;
            font-size: 0.82rem;
            line-height: 1.6;
        }

        .line-preview-label {
            font-size: 0.72rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
            font-weight: 600;
        }

        /* ========== å†è©¦è¡Œãƒœã‚¿ãƒ³ ========== */
        .btn-retry {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            border: 1.5px solid #e57373;
            border-radius: 8px;
            background: #fff;
            color: #c62828;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-retry:active {
            background: #ffebee;
        }

        /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ========== */
        @media (prefers-color-scheme: dark) {
            body {
                background: #121212;
                color: #e0e0e0;
            }

            .card {
                background: #1e1e1e;
                box-shadow: none;
                border: 1px solid #333;
            }

            input,
            select,
            textarea {
                background: #2c2c2c;
                border-color: #444;
                color: #e0e0e0;
            }

            .tab-bar {
                background: #1e1e1e;
            }

            .tab {
                color: #999;
            }

            .tab.active {
                color: #66bb6a;
                border-bottom-color: #66bb6a;
            }

            .booking-item {
                border-color: #333;
            }

            .bi-name {
                color: #e0e0e0;
            }

            .bi-sub {
                color: #aaa;
            }

            .slot-btn {
                background: #2c2c2c;
                border-color: #444;
                color: #e0e0e0;
            }

            .slot-btn.selected {
                background: #1b5e20;
                border-color: #2e7d32;
            }

            .diag-group-title {
                background: #1a2e1a;
                color: #a5d6a7;
            }

            .today-summary {
                background: #1a2e1a;
            }

            .today-summary .ts-count {
                color: #81c784;
            }

            .skeleton-item,
            .skeleton-line {
                background: linear-gradient(90deg, #2c2c2c 25%, #383838 50%, #2c2c2c 75%);
            }

            .bottom-sheet {
                background: #1e1e1e;
            }

            .stat-card {
                background: #1a2e1a;
            }

            .week-day {
                background: #1a2e1a;
            }

            .week-day.wd-today {
                border-color: #66bb6a;
                background: #1b3a1b;
            }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: æ‰‹å‹•ãƒˆã‚°ãƒ«ã§è¿½åŠ  */
        body.dark {
            background: #121212;
            color: #e0e0e0;
        }

        body.dark .card {
            background: #1e1e1e;
            box-shadow: none;
            border: 1px solid #333;
        }

        body.dark input,
        body.dark select {
            background: #2c2c2c;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark .tab-bar {
            background: #1e1e1e;
        }

        body.dark .tab {
            color: #999;
        }

        body.dark .tab.active {
            color: #66bb6a;
            border-bottom-color: #66bb6a;
        }

        body.dark .booking-item {
            border-color: #333;
        }

        body.dark .bi-name {
            color: #e0e0e0;
        }

        body.dark .bi-sub {
            color: #aaa;
        }

        body.dark .slot-btn {
            background: #2c2c2c;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark .slot-btn.selected {
            background: #1b5e20;
            border-color: #2e7d32;
        }

        body.dark .diag-group-title {
            background: #1a2e1a;
            color: #a5d6a7;
        }

        body.dark .today-summary {
            background: #1a2e1a;
        }

        body.dark .skeleton-item,
        body.dark .skeleton-line {
            background: linear-gradient(90deg, #2c2c2c 25%, #383838 50%, #2c2c2c 75%);
            background-size: 400px 100%;
            animation: shimmer 1.4s infinite linear;
        }

        body.dark .bottom-sheet {
            background: #1e1e1e;
        }

        body.dark .stat-card {
            background: #1a2e1a;
        }

        body.dark .week-day {
            background: #1a2e1a;
        }
    </style>
</head>

<body>

    <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
    <div class="app-header" style="position:relative">
        <h1>MYTONE äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div id="salonBadge" class="salon-badge hidden"></div>
        <div id="roleBadge" class="role-badge hidden"></div>
        <button class="dark-toggle" onclick="toggleDarkMode()">&#127769;</button>
    </div>

    <!-- ãƒ—ãƒ«ãƒˆã‚¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="pullIndicator">&#8595; å¼•ã£å¼µã£ã¦æ›´æ–°</div>

    <!-- ========== åˆæœŸåŒ–ä¸­ ========== -->
    <div id="screenLoading" class="container">
        <div class="loading-screen">
            <div class="spinner"></div>
            <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- ========== æœªç™»éŒ²ç”»é¢ ========== -->
    <div id="screenRegister" class="container hidden">
        <div class="register-hero">
            <div class="icon">ğŸ‘¤</div>
            <p>ç¾å®¹å®¤ã‚¹ã‚¿ãƒƒãƒ•ã¾ãŸã¯è¨ºæ–­å£«ã¨ã—ã¦<br>ã”ç™»éŒ²ãã ã•ã„</p>
        </div>
        <div class="card">
            <div class="tab-bar">
                <div class="tab active" onclick="switchRegTab('staff')">ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</div>
                <div class="tab" onclick="switchRegTab('diag')">è¨ºæ–­å£«ç™»éŒ²</div>
            </div>
            <div id="regStaff">
                <label>åº—èˆ—ã‚³ãƒ¼ãƒ‰</label>
                <input id="regSalonCode" placeholder="ä¾‹: S00001" autocomplete="off">
                <button class="btn btn-primary" onclick="doLinkSalon()">ç™»éŒ²ã™ã‚‹</button>
            </div>
            <div id="regDiag" class="hidden">
                <label>è¨ºæ–­å£«ID</label>
                <input id="regDiagId" placeholder="ä¾‹: D00001" autocomplete="off">
                <button class="btn btn-primary" onclick="doLinkDiag()">ç™»éŒ²ã™ã‚‹</button>
            </div>
            <div id="regMsg"></div>
        </div>
    </div>

    <!-- ========== ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ ========== -->
    <div id="screenStaff" class="container hidden">
        <div class="tab-bar" id="staffTabs">
            <div class="tab active" onclick="switchStaffTab('new')">æ–°è¦äºˆç´„</div>
            <div class="tab" onclick="switchStaffTab('list')">äºˆç´„ä¸€è¦§</div>
        </div>

        <!-- æ–°è¦äºˆç´„ -->
        <div id="staffNew">
            <!-- ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
            <div id="todaySummary" class="today-summary hidden" onclick="switchStaffTab('list')">
                <span>ğŸ“…</span>
                <span class="ts-count" id="todayCount">0</span>
                <span class="ts-label">æœ¬æ—¥ã®äºˆç´„ â€º ä¸€è¦§ã¸</span>
            </div>
            <!-- Stepç¨®åˆ¥é¸æŠ -->
            <div class="card" id="stepSelect">
                <div class="card-title">äºˆç´„ç¨®åˆ¥ã‚’é¸æŠ</div>
                <button class="btn btn-primary" onclick="startStep('STEP1')">ğŸ“‹ STEP1 åˆå›è¨ºæ–­</button>
                <button class="btn btn-outline" onclick="startStep2Search()" style="margin-top:10px">ğŸ”„ STEP2
                    ãƒ•ã‚©ãƒ­ãƒ¼è¨ºæ–­</button>
            </div>

            <!-- STEP2: è¦ªSTEP1æ¤œç´¢ -->
            <div class="card hidden" id="step2ParentSearch">
                <div class="card-title">STEP2: è¦ª STEP1 ã‚’æ¤œç´¢</div>
                <label>é¡§å®¢é›»è©±ç•ªå·</label>
                <input id="s2Phone" type="tel" placeholder="09012345678">
                <button class="btn btn-primary" onclick="doFindParent()">æ¤œç´¢</button>
                <div id="s2ParentList"></div>
                <div id="s2Msg"></div>
                <button class="btn btn-outline" onclick="resetNewBooking()" style="margin-top:10px">â† æˆ»ã‚‹</button>
            </div>

            <!-- é¡§å®¢æƒ…å ±å…¥åŠ› -->
            <div class="card hidden" id="custInfo">
                <div class="card-title" id="custStepLabel"></div>
                <label>é¡§å®¢å <span style="color:#e53935">*</span></label>
                <input id="custName" placeholder="å±±ç”° å¤ªéƒ">
                <label>é›»è©±ç•ªå· <span style="color:#e53935">*</span></label>
                <input id="custPhone" type="tel" placeholder="09012345678">
                <!-- éå»é¡§å®¢åã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ææ¡ˆ -->
                <div id="custNameSuggest" class="hidden" style="margin-top:4px"></div>
                <label>æ€§åˆ¥</label>
                <select id="custGender">
                    <option value="">æœªé¸æŠ</option>
                    <option>ç”·æ€§</option>
                    <option>å¥³æ€§</option>
                    <option>ãã®ä»–</option>
                </select>
                <label>å¹´é½¢</label>
                <input id="custAge" type="number" placeholder="30" min="0" max="120">
                <button class="btn btn-primary" onclick="goToDateInput()" style="margin-top:14px">æ¬¡ã¸: æ—¥ã«ã¡é¸æŠ â†’</button>
                <button class="btn btn-outline" onclick="resetNewBooking()" style="margin-top:8px">â† æˆ»ã‚‹</button>
                <button class="btn btn-secondary" onclick="doViewHistory()" style="margin-top:8px;font-size:0.82rem">ğŸ“
                    éå»ã®äºˆç´„ã‚’ç¢ºèª</button>
            </div>

            <!-- æ—¥ä»˜å…¥åŠ›ï¼‹ç©ºãæ¤œç´¢ -->
            <div class="card hidden" id="dateSearch">
                <div class="card-title">æ—¥ã«ã¡æŒ‡å®šãƒ»ç©ºãæ¤œç´¢</div>
                <!-- é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
                <div class="diag-filter-label">&#128197; é€±é–“ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¿ãƒƒãƒ—ã§æ—¥ä»˜é¸æŠï¼‰</div>
                <div class="week-cal" id="weekCalArea"></div>
                <label style="margin-top:12px">åŸºæº–æ—¥</label>
                <div class="date-nav">
                    <button class="btn-nav" onclick="shiftDate('searchDate',-1)">&#9668;</button>
                    <input id="searchDate" type="date">
                    <button class="btn-nav" onclick="shiftDate('searchDate',1)">&#9658;</button>
                </div>
                <!-- è¨ºæ–­å£«ã‚’æŒ‡åã—ã¦æ¤œç´¢ -->
                <div class="diag-filter-label">&#128104;&#8205;&#9877;&#65039; è¨ºæ–­å£«ã‚’æŒ‡å®šï¼ˆä»»æ„ï¼‰</div>
                <select id="diagFilter" style="margin-bottom:0">
                    <option value="">&#9675; æŒ‡å®šãªã—ï¼ˆå…¨å“¡å¯¾è±¡ï¼‰</option>
                </select>
                <button class="btn btn-primary" onclick="doSearchSlots()" style="margin-top:14px">&#128269;
                    ç©ºãã‚’æ¤œç´¢</button>
                <div id="slotsArea" style="margin-top:12px"></div>
                <button class="btn btn-secondary hidden" id="btnFallback" onclick="doSearchFallback()"
                    style="margin-top:8px">åˆ¥ã®è¨ºæ–­å£«ã§ã‚‚æ¢ã™</button>
            </div>

            <!-- ç¢ºèªç”»é¢ï¼ˆãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆå†…ã«ç§»å‹•) -->
        </div>

        <!-- äºˆç´„ä¸€è¦§ -->
        <div id="staffList" class="hidden">
            <!-- ç®¡ç†è€…çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="card" id="adminStats" style="margin-bottom:10px">
                <div class="card-title">ğŸ“Š ä»Šæœˆã®ã‚µãƒãƒªãƒ¼</div>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statToday">-</div>
                        <div class="stat-label">æœ¬æ—¥ã®äºˆç´„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWeek">-</div>
                        <div class="stat-label">ä»Šé€±ã®äºˆç´„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMonth">-</div>
                        <div class="stat-label">ä»Šæœˆã®äºˆç´„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">æœ€çµ‚ç¢ºå®šæ¸ˆ</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">äºˆç´„ä¸€è¦§ï¼ˆæœ¬æ—¥ä»¥é™ï¼‰</div>
                <label>é›»è©±ç•ªå·ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰</label>
                <input id="listPhone" type="tel" placeholder="09012345678">
                <button class="btn btn-secondary" onclick="doListBookings()" style="margin-top:10px">ğŸ” æ¤œç´¢</button>
                <div id="bookingsList" style="margin-top:12px"></div>
            </div>

            <!-- å¤‰æ›´ã‚¨ãƒªã‚¢ -->
            <div class="card hidden" id="changeArea">
                <div class="card-title">äºˆç´„å¤‰æ›´</div>
                <div id="changeInfo" class="msg-info"></div>
                <label>æ–°ã—ã„åŸºæº–æ—¥</label>
                <div class="date-nav">
                    <button class="btn-nav" onclick="shiftDate('changeDate',-1)">â—„</button>
                    <input id="changeDate" type="date">
                    <button class="btn-nav" onclick="shiftDate('changeDate',1)">â–º</button>
                </div>
                <button class="btn btn-primary" onclick="doSearchChangeSlots()" style="margin-top:10px">ğŸ”
                    ç©ºãã‚’æ¤œç´¢</button>
                <div id="changeSlotsArea" style="margin-top:12px"></div>
                <button class="btn btn-primary hidden" id="btnConfirmChange" onclick="doConfirmChange()"
                    style="margin-top:8px">ã“ã®æ—¥æ™‚ã«å¤‰æ›´ã™ã‚‹</button>
                <button class="btn btn-outline" onclick="closeChangeArea()" style="margin-top:8px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <div id="changeMsg"></div>
            </div>
        </div>
    </div>

    <!-- ========== è¨ºæ–­å£«ç”»é¢ ========== -->
    <div id="screenDiag" class="container hidden">
        <div class="tab-bar">
            <div class="tab active" onclick="switchDiagTab('add')">ç¨¼åƒæ è¿½åŠ </div>
            <div class="tab" onclick="switchDiagTab('list')">ç¨¼åƒæ ä¸€è¦§</div>
        </div>

        <div id="diagAdd">
            <div class="card">
                <div class="card-title">ç¨¼åƒæ ã‚’è¿½åŠ </div>
                <label>æ—¥ä»˜</label>
                <input id="availDate" type="date">
                <label>é–‹å§‹æ™‚åˆ»ï¼ˆ30åˆ†åˆ»ã¿ï¼‰</label>
                <select id="availTime"></select>
                <label>ãƒ–ãƒ­ãƒƒã‚¯æ•°ï¼ˆ1ãƒ–ãƒ­ãƒƒã‚¯ = 130åˆ†ï¼‰</label>
                <select id="availBlocks">
                    <option value="1">1ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ130åˆ†ï¼‰</option>
                    <option value="2">2ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ260åˆ†ï¼‰</option>
                    <option value="3">3ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ390åˆ†ï¼‰</option>
                </select>
                <!-- ç¹°ã‚Šè¿”ã—ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                <label style="margin-top:10px">ğŸ”„ ç¹°ã‚Šè¿”ã—ç™»éŒ²</label>
                <select id="availRepeat">
                    <option value="0">ç¹°ã‚Šè¿”ã—ãªã—ï¼ˆä¸€å›ã®ã¿ï¼‰</option>
                    <option value="1">1é€±é–“ç¹°ã‚Šè¿”ã™ï¼ˆ2å›ï¼‰</option>
                    <option value="2">2é€±é–“ç¹°ã‚Šè¿”ã™ï¼ˆ3å›ï¼‰</option>
                    <option value="3">3é€±é–“ç¹°ã‚Šè¿”ã™ï¼ˆ4å›ï¼‰</option>
                    <option value="4">4é€±é–“ç¹°ã‚Šè¿”ã™ï¼ˆ5å›ï¼‰</option>
                </select>
                <button class="btn btn-primary" onclick="doCreateAvail()" style="margin-top:14px">â• ç¨¼åƒæ ã‚’ä½œæˆ</button>
                <div id="availMsg"></div>
            </div>
        </div>

        <div id="diagList" class="hidden">
            <div class="card">
                <div class="card-title">ç¨¼åƒæ ä¸€è¦§ï¼ˆ2é€±é–“ï¼‰</div>
                <button class="btn btn-secondary" onclick="doListAvail()">ğŸ”„ æ›´æ–°</button>
                <div id="availList" style="margin-top:12px"></div>
            </div>
        </div>
    </div>

    <!-- ========== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ + ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ ========== -->
    <div id="sheetOverlay" class="sheet-overlay" onclick="closeConfirmSheet()"></div>
    <div id="confirmSheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">äºˆç´„å†…å®¹ã®ç¢ºèª</div>
        <div id="sheetConfirmDetail"></div>
        <!-- LINEé€šçŸ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="line-preview-label">ğŸ“± è¨ºæ–­å£«ã¸ã®LINEé€šçŸ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div id="linePreviewBox" class="line-preview">â€¦</div>
        <button class="btn btn-primary" onclick="doCreateBooking()" style="margin-top:14px">âœ… äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
        <button class="btn btn-outline" onclick="closeConfirmSheet()" style="margin-top:8px">â† æˆ»ã‚‹</button>
        <div id="sheetConfirmMsg"></div>
    </div>

    <!-- é¡§å®¢å±¥æ­´ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ -->
    <div id="historyOverlay" class="sheet-overlay" onclick="closeHistorySheet()"></div>
    <div id="historySheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">ğŸ“ é¡§å®¢å±¥æ­´</div>
        <div id="historyContent">
            <div class="loading-text" style="text-align:center;padding:20px">èª­è¾¼ä¸­...</div>
        </div>
    </div>

    <script>
        /* ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ========== */
        const STATE = {
            line_user_id: '',
            role: '',
            salon_id: '',
            diag_id: '',
            step_type: '',
            parent_booking_id: '',
            preferred_diag_id: '',
            customer: {},
            selectedSlot: null,
            selectedDiagId: '',
            selectedDiagName: '',
            changeBookingId: '',
            changeSlot: null,
        };

        /* ========== è¨­å®š: ã“ã“ã ã‘å¤‰æ›´ã™ã‚‹ ========== */
        // LINE Developers Console ã® LIFF ID
        const LIFF_ID = '2009132853-rlGuhhMj';
        // GAS ãƒ‡ãƒ—ãƒ­ã‚¤URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç† â†’ ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLï¼‰
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJ6RasshdyfQVueQvWu58MIS-ILVXDwxiK-6m4lmCmhV28m_ebOOhwhWLL36yW3JJ-mg/exec';

        // LIFF SDK ã‚’è¤‡æ•°CDNã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãã§å‹•çš„èª­ã¿è¾¼ã¿
        function loadSdk(urls, onSuccess, onFail) {
            if (urls.length === 0) { onFail(); return; }
            var s = document.createElement('script');
            s.src = urls[0];
            s.onload = onSuccess;
            s.onerror = function () { loadSdk(urls.slice(1), onSuccess, onFail); };
            document.head.appendChild(s);
        }

        document.addEventListener('DOMContentLoaded', function () {
            showStep('LIFF SDK èª­ã¿è¾¼ã¿ä¸­...');
            loadSdk(
                [
                    'https://cdn.jsdelivr.net/npm/@line/liff@2.22.3/dist/liff.min.js',
                    'https://unpkg.com/@line/liff@2.22.3/dist/liff.min.js',
                    'https://static.line-scdn.net/liff/edge/2/sdk.js'
                ],
                function () {
                    if (typeof liff === 'undefined') {
                        showStep('âš ï¸ LIFF SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', true);
                        return;
                    }
                    initLiff();
                },
                function () {
                    showStep('âš ï¸ LIFF SDKã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
                }
            );
        });

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã«ã‚¹ãƒ†ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showStep(msg, isError) {
            const cls = isError ? 'msg-error' : 'loading-text';
            el('screenLoading').innerHTML =
                '<div class="loading-screen">'
                + (isError ? '' : '<div class="spinner"></div>')
                + '<div class="' + cls + '" style="text-align:center;padding:0 16px">' + msg + '</div>'
                + '</div>';
        }

        async function initLiff() {
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ã Promise
            function withTimeout(promise, ms, label) {
                return Promise.race([
                    promise,
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error(label + ' ãŒ ' + (ms / 1000) + 'ç§’ä»¥å†…ã«å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ')), ms)
                    )
                ]);
            }

            try {
                // STEP 1: LIFF_ID ç¢ºèª
                showStep('ã‚¹ãƒ†ãƒƒãƒ— 1/4: LIFF ID ç¢ºèªä¸­...');
                console.log('LIFF_ID:', LIFF_ID);
                if (!LIFF_ID || LIFF_ID === '') {
                    showStep('âš ï¸ LIFF IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚GASã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ŒLIFF_IDã€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
                    return;
                }

                // STEP 2: liff.init()
                const liffIdTrimmed = LIFF_ID.trim();
                showStep('ã‚¹ãƒ†ãƒƒãƒ— 2/4: LIFF åˆæœŸåŒ–ä¸­... (ID: ' + liffIdTrimmed + ' [len:' + liffIdTrimmed.length + '])');
                try {
                    await liff.init({ liffId: liffIdTrimmed });
                } catch (initErr) {
                    // initå¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨URLè©³ç´°ã‚’è¡¨ç¤º
                    const baseUrl = location.href.split('?')[0].split('#')[0];
                    const errCode = initErr.code || initErr.errorCode || 'N/A';
                    showStep(
                        'âš ï¸ LIFFåˆæœŸåŒ–å¤±æ•—<br>'
                        + 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + (initErr.message || String(initErr)) + '<br>'
                        + 'ã‚³ãƒ¼ãƒ‰: ' + errCode + '<br>'
                        + 'ãƒ™ãƒ¼ã‚¹URL: <small style="word-break:break-all">' + baseUrl + '</small>',
                        true
                    );
                    return;
                }

                // STEP 3: ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
                showStep('ã‚¹ãƒ†ãƒƒãƒ— 3/4: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªä¸­...');
                if (!liff.isLoggedIn()) {
                    showStep('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...');
                    liff.login();
                    return;
                }

                // STEP 4: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                showStep('ã‚¹ãƒ†ãƒƒãƒ— 4/4: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ä¸­...');
                const profile = await withTimeout(
                    liff.getProfile(),
                    10000,
                    'liff.getProfile()'
                );
                STATE.line_user_id = profile.userId;
                console.log('line_user_id:', STATE.line_user_id.substring(0, 6) + '...');

                showStep('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...');
                bootstrap();
            } catch (e) {
                console.error('LIFF init error:', e);
                showStep('âš ï¸ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)), true);
            }
        }

        /* ========== Bootstrap ========== */
        function bootstrap() {
            showStep('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­...');

            // apiBootstrap ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            const timer = setTimeout(function () {
                showStep('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (15ç§’)ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', true);
            }, 15000);

            callApi('apiBootstrap', { line_user_id: STATE.line_user_id }, (res) => {
                clearTimeout(timer);
                hide('screenLoading');
                if (!res.ok) { showFatalError(res.error); return; }
                STATE.role = res.role;
                if (res.role === 'staff') {
                    STATE.salon_id = res.salon_id;
                    setBadge('ã‚¹ã‚¿ãƒƒãƒ•');
                    // åº—èˆ—åãƒãƒƒã‚¸è¡¨ç¤º
                    if (res.salon_name) {
                        const sb = el('salonBadge');
                        sb.textContent = 'ğŸª ' + res.salon_name;
                        sb.classList.remove('hidden');
                    }
                    show('screenStaff');
                    initStaffUI();
                    // ä»Šæ—¥ã®äºˆç´„ä»¶æ•°ï¼ˆGASãŒè¿”ã™å ´åˆã®ã¿è¡¨ç¤ºï¼‰
                    if (res.today_count !== undefined && res.today_count > 0) {
                        el('todayCount').textContent = res.today_count + 'ä»¶';
                        show('todaySummary');
                    }
                } else if (res.role === 'diagnostician') {
                    STATE.diag_id = res.diag_id;
                    setBadge('è¨ºæ–­å£«');
                    show('screenDiag');
                    initDiagUI();
                } else {
                    show('screenRegister');
                }
            });
        }

        function setBadge(label) {
            const b = el('roleBadge');
            b.textContent = label;
            b.classList.remove('hidden');
        }

        function showFatalError(msg) {
            el('screenLoading').innerHTML = `<div class="container"><div class="msg-error" style="margin-top:40px">âš ï¸ ${esc(msg)}</div></div>`;
            show('screenLoading');
        }

        /* ========== ç™»éŒ²ç”»é¢ ========== */
        function switchRegTab(tab) {
            const tabs = document.querySelectorAll('#screenRegister .tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'staff') {
                tabs[0].classList.add('active');
                show('regStaff'); hide('regDiag');
            } else {
                tabs[1].classList.add('active');
                hide('regStaff'); show('regDiag');
            }
            el('regMsg').innerHTML = '';
        }

        function doLinkSalon() {
            const code = el('regSalonCode').value.trim();
            if (!code) { el('regMsg').innerHTML = '<div class="msg-error">åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; return; }
            el('regMsg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">ç™»éŒ²ä¸­...</div>';
            callApi('apiLinkSalon', { line_user_id: STATE.line_user_id, salon_code: code }, (res) => {
                if (!res.ok) { el('regMsg').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                STATE.role = 'staff'; STATE.salon_id = res.salon_id;
                setBadge('ã‚¹ã‚¿ãƒƒãƒ•');
                hide('screenRegister'); show('screenStaff');
                initStaffUI();
                el('regMsg').innerHTML = '';
                showToast(`${res.salon_name} ã®ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ âœ…`);
            });
        }

        function doLinkDiag() {
            const id = el('regDiagId').value.trim();
            if (!id) { el('regMsg').innerHTML = '<div class="msg-error">è¨ºæ–­å£«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; return; }
            el('regMsg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">ç™»éŒ²ä¸­...</div>';
            callApi('apiLinkDiagnostician', { line_user_id: STATE.line_user_id, diag_id: id }, (res) => {
                if (!res.ok) { el('regMsg').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                STATE.role = 'diagnostician'; STATE.diag_id = res.diag_id;
                setBadge('è¨ºæ–­å£«');
                hide('screenRegister'); show('screenDiag');
                initDiagUI();
                el('regMsg').innerHTML = '';
                showToast(`${res.diag_name} ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ âœ…`);
            });
        }

        /* ========== ã‚¹ã‚¿ãƒƒãƒ•UI ========== */
        function initStaffUI() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            el('searchDate').value = fmtDate(tomorrow);
            el('changeDate').value = fmtDate(tomorrow);
            // é›»è©±ç•ªå·å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è‡ªå‹•æ•´å½¢ï¼ˆæ•°å­—ã®ã¿è¨±å¯ï¼‰
            ['custPhone', 's2Phone', 'listPhone'].forEach(function (id) {
                var inp = el(id);
                if (inp) inp.addEventListener('input', function () {
                    var v = this.value.replace(/\D/g, '');
                    if (this.value !== v) this.value = v;
                });
            });
            // custPhone: å…¥åŠ›å¾Œã«éå»é¡§å®¢åã‚’æ¤œç´¢ã—ã¦ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ææ¡ˆ
            el('custPhone').addEventListener('change', function () {
                const phone = this.value.trim();
                const suggestEl = el('custNameSuggest');
                if (!phone || phone.length < 7) { hide('custNameSuggest'); return; }
                callApi('apiFindCustomerByPhone', { line_user_id: STATE.line_user_id, customer_phone: phone }, (res) => {
                    if (!res.ok || !res.customer_name) { hide('custNameSuggest'); return; }
                    // é¡§å®¢åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã®ã¨ãã®ã¿ææ¡ˆ
                    if (el('custName').value.trim()) { hide('custNameSuggest'); return; }
                    suggestEl.innerHTML = `
<div class="msg-info" style="display:flex;align-items:center;gap:8px;padding:8px 10px;">
  <span style="flex:1">ğŸ’¡ éå»ã®é¡§å®¢: <strong>${esc(res.customer_name)}</strong></span>
  <button class="btn-copy" onclick="el('custName').value='${esc(res.customer_name)}';hide('custNameSuggest')">ä½¿ã†</button>
</div>`;
                    show('custNameSuggest');
                });
            });
            // è¨ºæ–­å£«ãƒªã‚¹ãƒˆèª­è¾¼ + é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» + ãƒ—ãƒ«ãƒˆã‚¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            loadDiagList();
            renderWeekCal();
            setPullToRefresh(() => doListBookings());
            resetNewBooking();
        }

        function switchStaffTab(tab) {
            const tabs = document.querySelectorAll('#staffTabs .tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'new') {
                tabs[0].classList.add('active');
                show('staffNew'); hide('staffList');
            } else {
                tabs[1].classList.add('active');
                hide('staffNew'); show('staffList');
                doListBookings();
                doAdminStats(); // çµ±è¨ˆæ›´æ–°
            }
        }

        /* --- æ–°è¦äºˆç´„ãƒ•ãƒ­ãƒ¼ --- */
        function resetNewBooking() {
            STATE.step_type = ''; STATE.parent_booking_id = ''; STATE.preferred_diag_id = '';
            STATE.customer = {}; STATE.selectedSlot = null; STATE.selectedDiagId = ''; STATE.selectedDiagName = '';
            closeConfirmSheet();
            show('stepSelect');
            hide('step2ParentSearch'); hide('custInfo'); hide('dateSearch');
            el('slotsArea').innerHTML = ''; hide('btnFallback');
        }

        function startStep(step) {
            STATE.step_type = step;
            STATE.parent_booking_id = '';
            STATE.preferred_diag_id = '';
            hide('stepSelect');
            show('custInfo');
            el('custStepLabel').textContent = step === 'STEP1' ? 'ğŸ“‹ STEP1 åˆå›è¨ºæ–­' : 'ğŸ”„ STEP2 ãƒ•ã‚©ãƒ­ãƒ¼è¨ºæ–­';
            el('custName').value = ''; el('custPhone').value = '';
            el('custGender').value = ''; el('custAge').value = '';
        }

        function startStep2Search() {
            STATE.step_type = 'STEP2';
            hide('stepSelect');
            show('step2ParentSearch');
            el('s2Phone').value = ''; el('s2ParentList').innerHTML = ''; el('s2Msg').innerHTML = '';
        }

        function doFindParent() {
            const phone = el('s2Phone').value.trim();
            if (!phone) { el('s2Msg').innerHTML = '<div class="msg-error">é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; return; }
            el('s2Msg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">æ¤œç´¢ä¸­...</div>';
            callApi('apiFindParentStep1', { line_user_id: STATE.line_user_id, customer_phone: phone }, (res) => {
                el('s2Msg').innerHTML = '';
                if (!res.ok) { el('s2Msg').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                if (res.parents.length === 0) {
                    el('s2ParentList').innerHTML = '<div class="msg-warn">è©²å½“ã™ã‚‹STEP1ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                let h = '<p style="font-size:.85rem;color:#555;margin:8px 0 4px">è¦ªSTEP1ã‚’é¸æŠã—ã¦ãã ã•ã„:</p>';
                for (const p of res.parents) {
                    const dt = fmtDt(p.start_at);
                    h += `<button class="slot-btn" onclick="selectParent('${esc(p.booking_id)}','${esc(p.diag_id)}','${esc(p.customer_name)}','${esc(p.customer_phone)}')">`
                        + `ğŸ‘¤ ${esc(p.customer_name)} / ${dt}<br><small style="font-weight:normal">è¨ºæ–­å£«: ${esc(p.diag_name)}</small></button>`;
                }
                el('s2ParentList').innerHTML = h;
            });
        }

        function selectParent(bookingId, diagId, custName, custPhone) {
            STATE.parent_booking_id = bookingId;
            STATE.preferred_diag_id = diagId;
            hide('step2ParentSearch');
            show('custInfo');
            el('custStepLabel').textContent = 'ğŸ”„ STEP2 ãƒ•ã‚©ãƒ­ãƒ¼è¨ºæ–­ï¼ˆåŒä¸€è¨ºæ–­å£«å„ªå…ˆï¼‰';
            el('custName').value = custName;
            el('custPhone').value = custPhone;
        }

        function goToDateInput() {
            const name = el('custName').value.trim();
            const phone = el('custPhone').value.trim();
            if (!name || !phone) { showToast('é¡§å®¢åã¨é›»è©±ç•ªå·ã¯å¿…é ˆã§ã™', true); return; }
            STATE.customer = {
                name, phone,
                gender: el('custGender').value,
                age: el('custAge').value
            };
            hide('custInfo');
            show('dateSearch');
            el('slotsArea').innerHTML = '';
            hide('btnFallback');
        }

        function doSearchSlots() {
            const ymd = el('searchDate').value;
            if (!ymd) { showToast('åŸºæº–æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }
            showSkeleton('slotsArea', 3);
            hide('btnFallback');
            const diagFilter = el('diagFilter') ? el('diagFilter').value : '';
            const payload = {
                line_user_id: STATE.line_user_id,
                step_type: STATE.step_type,
                date_ymd: ymd,
                parent_booking_id: STATE.parent_booking_id || '',
                allow_fallback: false,
                diag_id_filter: diagFilter,
            };
            callApi('apiSearchSlots', payload, (res) => {
                if (!res.ok) { el('slotsArea').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                if (res.mode === 'no_preferred_slot') {
                    el('slotsArea').innerHTML = '<div class="msg-warn">åŒä¸€è¨ºæ–­å£«ã®ç©ºããŒã‚ã‚Šã¾ã›ã‚“</div>';
                    show('btnFallback');
                    return;
                }
                renderSlots(res.results, 'slotsArea');
                if (res.results.length === 0) {
                    el('slotsArea').innerHTML = '<div class="msg-warn">ç©ºããŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®æ—¥ä»˜ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
                }
            });
        }

        function doSearchFallback() {
            const ymd = el('searchDate').value;
            el('slotsArea').innerHTML = '<div class="loading-text" style="text-align:center;padding:16px"><div class="spinner" style="margin:0 auto 8px"></div>æ¤œç´¢ä¸­...</div>';
            hide('btnFallback');
            const payload = {
                line_user_id: STATE.line_user_id,
                step_type: STATE.step_type,
                date_ymd: ymd,
                parent_booking_id: STATE.parent_booking_id || '',
                allow_fallback: true,
            };
            callApi('apiSearchSlots', payload, (res) => {
                if (!res.ok) { el('slotsArea').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                renderSlots(res.results, 'slotsArea');
                if (res.results.length === 0) {
                    el('slotsArea').innerHTML = '<div class="msg-warn">ç©ºããŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                }
            });
        }

        function renderSlots(results, targetId) {
            let h = '';
            for (const group of results) {
                h += `<div class="diag-group"><div class="diag-group-title">ğŸ‘¨â€âš•ï¸ ${esc(group.diag_name)}</div>`;
                for (const s of group.slots) {
                    const lbl = fmtDt(s.start_at) + ' ã€œ ' + fmtTime(s.end_at);
                    h += `<button class="slot-btn" data-iso="${esc(s.start_at)}" data-did="${esc(group.diag_id)}" data-dn="${esc(group.diag_name)}" onclick="pickSlot(this)">ğŸ• ${lbl}</button>`;
                }
                h += '</div>';
            }
            el(targetId).innerHTML = h;
        }

        function pickSlot(btn) {
            document.querySelectorAll('#slotsArea .slot-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            STATE.selectedSlot = btn.dataset.iso;
            STATE.selectedDiagId = btn.dataset.did;
            STATE.selectedDiagName = btn.dataset.dn;
            const dt = fmtDt(STATE.selectedSlot);
            el('sheetConfirmDetail').innerHTML = `
<table class="confirm-table">
  <tr><td>ç¨®åˆ¥</td><td>${esc(STATE.step_type)}</td></tr>
  <tr><td>é¡§å®¢å</td><td>${esc(STATE.customer.name)}</td></tr>
  <tr><td>é›»è©±</td><td>${esc(STATE.customer.phone)}</td></tr>
  <tr><td>è¨ºæ–­å£«</td><td>${esc(STATE.selectedDiagName)}</td></tr>
  <tr><td>æ—¥æ™‚</td><td>${dt}</td></tr>
</table>`;
            el('sheetConfirmMsg').innerHTML = '';
            openConfirmSheet();
            updateLinePreview(); // LINEé€šçŸ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        }

        function backToSlots() {
            closeConfirmSheet();
            STATE.selectedSlot = null;
        }

        function doCreateBooking() {
            if (!STATE.selectedSlot) { showToast('æšã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }
            el('sheetConfirmMsg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">äºˆç´„ä½œæˆä¸­...</div>';
            const payload = {
                line_user_id: STATE.line_user_id,
                step_type: STATE.step_type,
                parent_booking_id: STATE.parent_booking_id || '',
                customer_name: STATE.customer.name,
                customer_phone: STATE.customer.phone,
                gender: STATE.customer.gender || '',
                age: STATE.customer.age || '',
                diag_id: STATE.selectedDiagId,
                start_at_iso: STATE.selectedSlot,
            };
            callApi('apiCreateBooking', payload, (res) => {
                if (!res.ok) {
                    el('sheetConfirmMsg').innerHTML = `<div class="msg-error">${esc(res.error)}</div>
<button class="btn-retry" onclick="doCreateBooking()">ğŸ”„ å†è©¦è¡Œ</button>`;
                    return;
                }
                // æˆåŠŸ: ãƒãƒ—ãƒ†ã‚£ã‚¯ã‚¹ + ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³è¡¨ç¤º
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                const bid = res.booking.booking_id;
                el('sheetConfirmMsg').innerHTML = `
<div class="msg-success">
  âœ… äºˆç´„ç¢ºå®š: <strong>${esc(bid)}</strong><br>
  <button class="btn-copy" onclick="copyId('${esc(bid)}')">&#128203; äºˆç´„IDã‚’ã‚³ãƒ”ãƒ¼</button>
  <small style="display:block;color:#2e7d32;margin-top:4px">è¨ºæ–­å£«ã¸é€šçŸ¥æ¸ˆ ğŸ“©</small>
</div>`;
                setTimeout(() => { closeConfirmSheet(); resetNewBooking(); }, 3500);
            });
        }

        /* --- äºˆç´„ä¸€è¦§ --- */
        function doListBookings() {
            const phone = el('listPhone').value.trim();
            showSkeleton('bookingsList', 3);
            callApi('apiListBookings', { line_user_id: STATE.line_user_id, q_phone: phone }, (res) => {
                if (!res.ok) {
                    el('bookingsList').innerHTML = `<div class="msg-error">${esc(res.error)}</div>
<button class="btn-retry" onclick="doListBookings()">ğŸ”„ å†è©¦è¡Œ</button>`;
                    return;
                }
                if (res.bookings.length === 0) {
                    el('bookingsList').innerHTML = '<div class="msg-info">è©²å½“ã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                // æ—¥ä»˜è¿‘æ¥åº¦ã®åˆ¤å®šåŸºæº–
                const now = new Date();
                const todayStr = fmtDate(now);
                const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = fmtDate(tomorrow);
                const weekLater = new Date(now); weekLater.setDate(weekLater.getDate() + 7);
                let h = '';
                for (const b of res.bookings) {
                    const startDate = new Date(b.start_at);
                    const startDateStr = fmtDate(startDate);
                    let dotCls = 'dot-later', dateCls = 'bi-date-later';
                    if (startDateStr === todayStr) { dotCls = 'dot-today'; dateCls = 'bi-date-today'; }
                    else if (startDateStr === tomorrowStr) { dotCls = 'dot-tomorrow'; dateCls = 'bi-date-tomorrow'; }
                    else if (startDate <= weekLater) { dotCls = 'dot-week'; dateCls = 'bi-date-week'; }
                    // STEP1ã®å ´åˆã¯STEP2äºˆç´„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    const step2Btn = b.step_type === 'STEP1'
                        ? `<button class="btn btn-outline btn-small" onclick="startStep2FromBooking('${esc(b.booking_id)}','${esc(b.diag_id)}','${esc(b.customer_name)}','${esc(b.customer_phone)}')">&#x1f504; STEP2äºˆç´„</button>`
                        : '';
                    h += `<div class="booking-item">
  <div class="bi-name">${esc(b.customer_name)}<span class="bi-step">${esc(b.step_type)}</span></div>
  <div class="bi-sub ${dateCls}"><span class="urgency-dot ${dotCls}"></span>ğŸ“… ${fmtDt(b.start_at)}</div>
  <div class="bi-sub">ğŸ‘¨â€âš•ï¸ ${esc(b.diag_name)}</div>
  <div class="bi-sub">ğŸ“ ${esc(b.customer_phone)}</div>
  <div class="bi-actions">
    <button class="btn btn-secondary btn-small" onclick="openChange('${esc(b.booking_id)}')">å¤‰æ›´</button>
    <button class="btn btn-danger btn-small" onclick="doCancel('${esc(b.booking_id)}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    ${step2Btn}
  </div>
</div>`;
                }
                el('bookingsList').innerHTML = h;
            });
        }

        /* --- å¤‰æ›´ãƒ•ãƒ­ãƒ¼ --- */
        function openChange(bookingId) {
            STATE.changeBookingId = bookingId;
            STATE.changeSlot = null;
            show('changeArea');
            el('changeInfo').textContent = `å¤‰æ›´å¯¾è±¡: ${bookingId}`;
            el('changeSlotsArea').innerHTML = '';
            hide('btnConfirmChange');
            el('changeMsg').innerHTML = '';
            el('changeArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeChangeArea() {
            hide('changeArea');
            STATE.changeBookingId = '';
        }

        function doSearchChangeSlots() {
            const ymd = el('changeDate').value;
            if (!ymd) { showToast('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', true); return; }
            el('changeSlotsArea').innerHTML = '<div class="loading-text" style="text-align:center;padding:16px"><div class="spinner" style="margin:0 auto 8px"></div>æ¤œç´¢ä¸­...</div>';
            hide('btnConfirmChange');
            callApi('apiSearchSlotsForChange', {
                line_user_id: STATE.line_user_id,
                booking_id: STATE.changeBookingId,
                date_ymd: ymd,
            }, (res) => {
                if (!res.ok) { el('changeSlotsArea').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                if (res.results.length === 0) {
                    el('changeSlotsArea').innerHTML = '<div class="msg-warn">ç©ºããŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                renderChangeSlots(res.results);
            });
        }

        function renderChangeSlots(results) {
            let h = '';
            for (const group of results) {
                h += `<div class="diag-group"><div class="diag-group-title">ğŸ‘¨â€âš•ï¸ ${esc(group.diag_name)}</div>`;
                for (const s of group.slots) {
                    const lbl = fmtDt(s.start_at) + ' ã€œ ' + fmtTime(s.end_at);
                    h += `<button class="slot-btn" data-iso="${esc(s.start_at)}" onclick="pickChangeSlot(this)">ğŸ• ${lbl}</button>`;
                }
                h += '</div>';
            }
            el('changeSlotsArea').innerHTML = h;
        }

        function pickChangeSlot(btn) {
            document.querySelectorAll('#changeSlotsArea .slot-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            STATE.changeSlot = btn.dataset.iso;
            show('btnConfirmChange');
        }

        function doConfirmChange() {
            if (!STATE.changeSlot) return;
            el('changeMsg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">å¤‰æ›´ä¸­...</div>';
            callApi('apiChangeBooking', {
                line_user_id: STATE.line_user_id,
                booking_id: STATE.changeBookingId,
                new_start_at_iso: STATE.changeSlot,
            }, (res) => {
                if (!res.ok) { el('changeMsg').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                el('changeMsg').innerHTML = `<div class="msg-success">âœ… å¤‰æ›´å®Œäº†: ${esc(res.booking.booking_id)}</div>`;
                setTimeout(() => { closeChangeArea(); doListBookings(); }, 2000);
            });
        }

        /* --- ã‚­ãƒ£ãƒ³ã‚»ãƒ« --- */
        function doCancel(bookingId) {
            if (!confirm(`äºˆç´„ ${bookingId} ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            callApi('apiCancelBooking', { line_user_id: STATE.line_user_id, booking_id: bookingId }, (res) => {
                if (!res.ok) { showToast(res.error, true); return; }
                if (navigator.vibrate) navigator.vibrate(80);
                showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                doListBookings();
            });
        }

        /* ========== æ—¥ä»˜ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
        function shiftDate(inputId, days) {
            const inp = el(inputId);
            if (!inp.value) {
                const d = new Date(); d.setDate(d.getDate() + 1);
                inp.value = fmtDate(d);
            }
            const d = new Date(inp.value + 'T00:00:00');
            d.setDate(d.getDate() + days);
            inp.value = fmtDate(d);
        }

        /* ========== ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆåˆ¶å¾¡ ========== */
        function openConfirmSheet() {
            el('sheetOverlay').classList.add('show');
            requestAnimationFrame(() => el('confirmSheet').classList.add('show'));
            document.body.style.overflow = 'hidden';
        }
        function closeConfirmSheet() {
            el('sheetOverlay').classList.remove('show');
            el('confirmSheet').classList.remove('show');
            document.body.style.overflow = '';
        }

        /* ========== äºˆç´„IDã‚³ãƒ”ãƒ¼ ========== */
        function copyId(id) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(id).then(() => showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + id));
            } else {
                const ta = document.createElement('textarea');
                ta.value = id; ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta); ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + id);
            }
        }

        /* ========== ä¸€è¦§ã‹ã‚‰STEP2ãƒ•ãƒ­ãƒ¼é–‹å§‹ ========== */
        function startStep2FromBooking(bookingId, diagId, custName, custPhone) {
            switchStaffTab('new');
            STATE.step_type = 'STEP2';
            STATE.parent_booking_id = bookingId;
            STATE.preferred_diag_id = diagId;
            hide('stepSelect');
            show('custInfo');
            el('custStepLabel').textContent = '&#x1f504; STEP2 \u30d5\u30a9\u30ed\u30fc\u8a3a\u65ad\uff08\u540c\u4e00\u8a3a\u65ad\u58eb\u512a\u5148\uff09';
            el('custName').value = custName;
            el('custPhone').value = custPhone;
        }

        /* ========== \u30c0\u30fc\u30af\u30e2\u30fc\u30c9 ========== */
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('mytone_dark', isDark ? '1' : '0');
        }
        // \u8d77\u52d5\u6642\u306b\u8a2d\u5b9a\u3092\u5fa9\u5143
        (function () {
            if (localStorage.getItem('mytone_dark') === '1') document.body.classList.add('dark');
        })();

        /* ========== \u30b9\u30b1\u30eb\u30c8\u30f3\u30ed\u30fc\u30c7\u30a3\u30f3\u30b0 ========== */
        function showSkeleton(targetId, count) {
            count = count || 3;
            var h = '';
            for (var i = 0; i < count; i++) {
                h += '<div class="skeleton-item"><div style="padding:12px"><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div></div>';
            }
            el(targetId).innerHTML = h;
        }

        /* ========== \u30d7\u30eb\u30c8\u30a5\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5 ========== */
        function setPullToRefresh(onRefresh) {
            let startY = 0, pulling = false;
            const pullEl = el('pullIndicator');
            document.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, { passive: true });
            document.addEventListener('touchmove', (e) => {
                if (window.scrollY === 0 && e.touches[0].clientY - startY > 60) {
                    pulling = true; pullEl.classList.add('visible');
                }
            }, { passive: true });
            document.addEventListener('touchend', () => {
                if (pulling) {
                    pulling = false; pullEl.classList.remove('visible');
                    if (typeof onRefresh === 'function') onRefresh();
                }
            });
        }

        /* ========== \u9031\u9593\u30ab\u30ec\u30f3\u30c0\u30fc\u30d3\u30e5\u30fc ========== */
        function renderWeekCal() {
            const calEl = el('weekCalArea');
            if (!calEl) return;
            const today = new Date();
            const DOW = ['\u65e5', '\u6708', '\u706b', '\u6c34', '\u6728', '\u91d1', '\u571f'];
            const curVal = el('searchDate') ? el('searchDate').value : '';
            let h = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const ymd = fmtDate(d);
                const isSel = curVal === ymd;
                const isToday = i === 0;
                h += `<div class="week-day${isToday ? ' wd-today' : ''}${isSel ? ' wd-selected' : ''}" onclick="if(el('searchDate'))el('searchDate').value='${ymd}';renderWeekCal()">
  <div class="wd-date">${d.getMonth() + 1}/${d.getDate()}</div>
  <div class="wd-dow">${DOW[d.getDay()]}</div>
  <div class="wd-slots">&nbsp;</div>
</div>`;
            }
            calEl.innerHTML = h;
        }

        /* ========== \u8a3a\u65ad\u58eb\u30ea\u30b9\u30c8\u8aad\u8fbc ========== */
        function loadDiagList() {
            const sel = el('diagFilter');
            if (!sel) return;
            callApi('apiGetDiagList', { line_user_id: STATE.line_user_id }, (res) => {
                if (!res.ok || !res.diags) return;
                sel.innerHTML = '<option value="">\u25cb \u6307\u5b9a\u306a\u3057\uff08\u5168\u54e1\u5bfe\u8c61\uff09</option>';
                res.diags.forEach(d => {
                    sel.innerHTML += `<option value="${esc(d.diag_id)}">${esc(d.diag_name)}</option>`;
                });
            });
        }

        /* ========== LINE\u901a\u77e5\u30d7\u30ec\u30d3\u30e5\u30fc ========== */
        function updateLinePreview() {
            const box = el('linePreviewBox');
            if (!box || !STATE.selectedSlot) return;
            const dt = fmtDt(STATE.selectedSlot);
            box.innerHTML = `\u3010MYTONE\u4e88\u7d04\u304a\u77e5\u3089\u305b\u3011<br>\u65b0\u3057\u3044\u4e88\u7d04\u304c\u5165\u308a\u307e\u3057\u305f&#x1f4c5;<br>\u9867\u5ba2\u540d: ${esc(STATE.customer.name || '')}<br>\u7a2e\u5225: ${esc(STATE.step_type)}<br>\u65e5\u6642: ${dt}<br>\u8a3a\u65ad\u58eb: ${esc(STATE.selectedDiagName)}<br><small>\u203b\u8a73\u7d30\u306f\u30b7\u30b9\u30c6\u30e0\u3067\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044</small>`;
        }

        /* ========== \u9867\u5ba2\u5c65\u6b74\u30b7\u30fc\u30c8 ========== */
        function doViewHistory() {
            const phone = el('custPhone').value.trim();
            if (!phone) { showToast('\u5148\u306b\u96fb\u8a71\u756a\u53f7\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044', true); return; }
            el('historyContent').innerHTML = '<div class="loading-text" style="text-align:center;padding:20px"><div class="spinner" style="margin:0 auto 8px"></div>\u8aad\u8fbc\u4e2d...</div>';
            openHistorySheet();
            callApi('apiGetCustomerHistory', { line_user_id: STATE.line_user_id, customer_phone: phone }, (res) => {
                if (!res.ok) { el('historyContent').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                if (!res.bookings || res.bookings.length === 0) {
                    el('historyContent').innerHTML = '<div class="msg-info">\u904e\u53bb\u306e\u4e88\u7d04\u306f\u3042\u308a\u307e\u305b\u3093</div>';
                    return;
                }
                let h = `<p style="font-size:.8rem;color:#666;margin-bottom:8px">\ud83d\udcde ${esc(phone)}</p>`;
                for (const b of res.bookings) {
                    const col = b.status === 'CONFIRMED' || b.status === 'CHANGED' ? '#2e7d32' : b.status === 'CANCELED' ? '#c62828' : '#888';
                    h += `<div class="history-item">\n  ${fmtDt(b.start_at)}<span class="history-step">${esc(b.step_type)}</span><br>\n  <span style="color:#555">\ud83d\udc68\u200d\u2695\ufe0f ${esc(b.diag_name)}</span>\n  <span style="float:right;font-size:.75rem;color:${col}">${esc(b.status)}</span>\n</div>`;
                }
                el('historyContent').innerHTML = h;
            });
        }
        function openHistorySheet() {
            el('historyOverlay').classList.add('show');
            requestAnimationFrame(() => el('historySheet').classList.add('show'));
            document.body.style.overflow = 'hidden';
        }
        function closeHistorySheet() {
            el('historyOverlay').classList.remove('show');
            el('historySheet').classList.remove('show');
            document.body.style.overflow = '';
        }

        /* ========== \u7ba1\u7406\u8005\u7d71\u8a08 ========== */
        function doAdminStats() {
            ['statToday', 'statWeek', 'statMonth', 'statTotal'].forEach(id => {
                const e = el(id); if (e) e.textContent = '\u2026';
            });
            callApi('apiAdminStats', { line_user_id: STATE.line_user_id }, (res) => {
                if (!res.ok) return;
                if (el('statToday')) el('statToday').textContent = res.today ?? '-';
                if (el('statWeek')) el('statWeek').textContent = res.week ?? '-';
                if (el('statMonth')) el('statMonth').textContent = res.month ?? '-';
                if (el('statTotal')) el('statTotal').textContent = res.total ?? '-';
            });
        }

        /* ========== \u30a8\u30e9\u30fc\u6642\u306e\u518d\u8a66\u884c\u30dc\u30bf\u30f3\u8868\u793a ========== */
        function showRetryError(targetId, msg, fn, payload, cb) {
            const retryJson = JSON.stringify({ fn, payload }).replace(/"/g, '&quot;');
            el(targetId).innerHTML = `<div class="msg-error">${esc(msg)}</div>
<button class="btn-retry" onclick='var d=JSON.parse(this.dataset.r);callApi(d.fn,d.payload,function(r){if(!r.ok){showRetryError("${targetId}",r.error,d.fn,d.payload,null);}else{el("${targetId}").innerHTML="";}}' data-r="${retryJson}">\ud83d\udd04 \u518d\u8a66\u884c</button>`;
        }

        /* ========== è¨ºæ–­å£«UI ========== */
        function initDiagUI() {
            const sel = el('availTime');
            sel.innerHTML = '';
            for (let h = 7; h <= 21; h++) {
                for (const m of ['00', '30']) {
                    const v = `${String(h).padStart(2, '0')}:${m}`;
                    sel.innerHTML += `<option value="${v}">${v}</option>`;
                }
            }
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            el('availDate').value = fmtDate(tomorrow);
        }

        function switchDiagTab(tab) {
            const tabs = document.querySelectorAll('#screenDiag .tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'add') {
                tabs[0].classList.add('active');
                show('diagAdd'); hide('diagList');
            } else {
                tabs[1].classList.add('active');
                hide('diagAdd'); show('diagList');
                doListAvail();
            }
        }

        function doCreateAvail() {
            const dv = el('availDate').value;
            const tv = el('availTime').value;
            const bv = el('availBlocks').value;
            if (!dv || !tv) { el('availMsg').innerHTML = '<div class="msg-error">æ—¥ä»˜ã¨æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„</div>'; return; }
            el('availMsg').innerHTML = '<div class="loading-text" style="text-align:center;padding:10px">ä½œæˆä¸­...</div>';
            const repeatWeeks = parseInt(el('availRepeat') ? el('availRepeat').value : '0') || 0;
            callApi('apiDiagCreateAvail', {
                line_user_id: STATE.line_user_id,
                date_ymd: dv,
                start_hhmm: tv,
                blocks: bv,
                repeat_weeks: repeatWeeks,
            }, (res) => {
                if (!res.ok) {
                    el('availMsg').innerHTML = `<div class="msg-error">${esc(res.error)}</div><button class="btn-retry" onclick="doCreateAvail()">&#x1f504; å†è©¦è¡Œ</button>`;
                    return;
                }
                const cnt = res.created_count || 1;
                el('availMsg').innerHTML = `<div class="msg-success">&#x2705; ç¨¼åƒæ ã‚’${cnt}ä»¶ä½œæˆã—ã¾ã—ãŸ</div>`;
            });
        }

        function doListAvail() {
            el('availList').innerHTML = '<div class="loading-text" style="text-align:center;padding:16px"><div class="spinner" style="margin:0 auto 8px"></div>èª­è¾¼ä¸­...</div>';
            callApi('apiDiagListAvail', { line_user_id: STATE.line_user_id }, (res) => {
                if (!res.ok) { el('availList').innerHTML = `<div class="msg-error">${esc(res.error)}</div>`; return; }
                if (res.avail.length === 0) {
                    el('availList').innerHTML = '<div class="msg-info">ç¨¼åƒæ ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                let h = '';
                for (const a of res.avail) {
                    h += `<div class="avail-item">
  <div class="avail-time">ğŸ“… ${fmtDt(a.start_at)} ã€œ ${fmtTime(a.end_at)}</div>
  <button class="btn btn-danger btn-small" onclick="doDeleteAvail('${esc(a.event_id)}')">å‰Šé™¤</button>
</div>`;
                }
                el('availList').innerHTML = h;
            });
        }

        function doDeleteAvail(eventId) {
            if (!confirm('ã“ã®ç¨¼åƒæ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            callApi('apiDiagDeleteAvail', { line_user_id: STATE.line_user_id, event_id: eventId }, (res) => {
                if (!res.ok) { showToast(res.error, true); return; }
                showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                doListAvail();
            });
        }

        /* ========== ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ========== */
        function showToast(msg, isError = false) {
            const t = document.createElement('div');
            t.textContent = msg;
            Object.assign(t.style, {
                position: 'fixed',
                bottom: '24px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: isError ? '#c62828' : '#2e7d32',
                color: '#fff',
                padding: '12px 20px',
                borderRadius: '24px',
                fontSize: '0.9rem',
                fontWeight: '600',
                zIndex: '9999',
                boxShadow: '0 4px 12px rgba(0,0,0,0.25)',
                maxWidth: '90vw',
                textAlign: 'center',
                transition: 'opacity 0.3s',
            });
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
        }

        /* ========== APIå‘¼ã³å‡ºã—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (fetchç‰ˆ) ========== */
        function callApi(fn, payload, cb) {
            // GAS doPost ã¸ POST ã™ã‚‹
            // Content-Type: text/plain ã§CORSãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã‚’å›é¿
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: fn, payload: payload }),
            })
                .then(function (res) { return res.json(); })
                .then(function (data) { cb(data); })
                .catch(function (err) { cb({ ok: false, error: String(err) }); });
        }

        /* ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼ ========== */
        function el(id) { return document.getElementById(id); }
        function show(id) { const e = el(id); if (e) e.classList.remove('hidden'); }
        function hide(id) { const e = el(id); if (e) e.classList.add('hidden'); }

        function esc(s) {
            if (s == null) return '';
            const d = document.createElement('div');
            d.textContent = String(s);
            return d.innerHTML;
        }

        function fmtDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
        }

        function fmtDt(iso) {
            const d = new Date(iso);
            return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function fmtTime(iso) {
            const d = new Date(iso);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }
    </script>
</body>

</html>
